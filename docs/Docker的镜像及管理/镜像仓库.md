# 镜像仓库

docker镜像需要有一个存放中心用于随时发布和拉取镜像.我们可以直接使用docker官方的[docker hub](https://hub.docker.com/)这个公共仓库.

但如果是一家严谨些的企业,通常是不愿意自己的镜像在外部可以被获取的.这也是自建镜像仓库的价值所在.

目前我所知最实用的镜像仓库项目是VMware公司开源的[harbor](https://github.com/goharbor/harbor).

无论使用哪种镜像仓库方案,我们和镜像仓库间的交互方式是一样的.

## 使用镜像仓库

### 验证权限(非必须)

一些仓库包括官方给出的镜像仓库工具[registry](https://docs.docker.com/registry/)也是没有权限控制的,那这步就不需要.
但如官方的[docker hub](https://hub.docker.com/)在内的大多数企业级解决方案都是有权限控制的.我们要使用这些仓库就先要去上面注册账号.

在有账号后我们需要在要上传拉取镜像的机器上登录一次账号让docker记住.

```bash
docker login [-u <用户名> -p <密码>] [<仓库地址>]
```

当仓库地址缺省时就是登录的docker hub.

当用户名和密码缺省时login操作会进入交互模式,会提示你输入用户名和密码.

需要注意的是docker对镜像仓库的操作默认都是使用的`HTTPS`协议,如果镜像仓库没有支持`HTTPS`协议,那么只能使用`HTTP`协议代替,这需要额外设置操作机器的docker配置:

+ 配置文件`daemon.json`

    ```json
    {
        "insecure-registries":["仓库地址"],
        ...
    }
    ```

### Docker Hub的镜像站

我们多数时候需要的镜像都是来自于Docker Hub,但Docker Hub毫无疑问的部署在墙外,因此在墙内的我们需要设置镜像站.
好在官方(`https://registry.docker-cn.com`),网易(`https://hub-mirror.c.163.com`),和科大(`https://docker.mirrors.ustc.edu.cn/`)都提供了镜像站.

配置方法是修改配置文件中的`registry-mirrors`项:

```json
{
  ...
  "registry-mirrors": [
    "https://registry.docker-cn.com",
    "https://hub-mirror.c.163.com",
    "https://docker.mirrors.ustc.edu.cn/"
  ],
  ...
}

```

### 将镜像上传至镜像仓库

镜像的分发基本上是依靠镜像仓库的.[docker hub](https://hub.docker.com/)是目前最大的docker镜像公有仓库,免费,注册了就可以用.我们也可以自己搭建私有镜像仓库.

要上传镜像首先需要登录镜像仓库,无论是公有的还是私有的只要有用户验证的步骤就一定需要先登录.

```bash
docker login [-p <密码> -u <用户名>] [私有仓库hostname[:私有仓库端口]]
```

如果没有在命令中指定用户名和密码,那么这条命令会进入一个命令行的交互界面让你填这些信息.如果没有指定私有仓库信息,那么这会默认登录Docker Hub.

在登录了镜像仓库后我们就可以上传镜像了.上传镜像的命令形式如下:

```bash
docker push dockerhub账号/镜像名[:版本]
```

在harbor中由于有二级目录,所以命令形式为:

```bash
docker push 私有镜像仓库地址/仓库二级目录名/镜像名[:版本]
```

我们可以指定版本上传也可以不指定,如果不指定,那么将会将`latest`版本的镜像上传了,如果希望上传全部镜像,可以在命令里添加flag`-a`.如果镜像仓库中已经有同名同标签的镜像,那么上传操作会将其覆盖.

#### 多平台镜像聚合

docker支持多平台的镜像使用相同的命名,但这需要将各个平台的镜像聚合构造成一份清单(`manifest`),如果docker指定使用的镜像实际是一份清单,则它会根据当前docker的执行平台来查找符合要求的镜像是否存在,如果存在,则执行,不存在则无法执行.

由于manifest本质上是镜像仓库的特性,所以要创建manifest必须先将原始镜像推送至镜像仓库,这样本地docker才能识别.

```bash
docker push xxxxx
```

我们的例子[example-image-build-push_manifest](https://github.com/hsz1273327/TutorialForDocker/tree/example-image-build-push_manifest)紧接着上一篇文章的例子

构造清单相关的操作使用`docker manifest`命令.将编译生成的不同平台的镜像手动打包

```bash
docker manifest create [--amend] {manifest_tag} \
{platform_tag} \
{platform_tag} \
...
```

如果是本地已经存在`manifest_tag`了我们只是修改它,那么我们需要指定flag`--amend`.它会用新创建的`manifest`替换掉原来的.

然后我们可以将清单推送到镜像仓库

```bash
docker manifest push [--purge] {manifest_tag}
```

如果指定`--purge`则本地的清单会被删除.如果镜像仓库中已经有同名同标签的清单,那么上传操作会将其覆盖.

##### 直接使用`buildx`上传清单

如果我们使用`buildx`构造多平台镜像,可以直接一步到位的上传清单和其中的全部镜像.
使用命令:

```bash
docker buildx build --push --platform={指定平台},{指定平台}.... -t {tag} . 
```

这种方式的`-t`实际上就是在给manifest打tag了,因此不用指定平台.

实测`--push`相当不稳定,经常会`io timeout`,因此不建议使用.还是老老实实先提交镜像再提交清单.

### 镜像拉取

除了在`docker-compose.yml`执行时拉取镜像外,我们也可以通过命令`docker pull <镜像标签[:版本]>`来直接拉取镜像,拉取的镜像会保存在本地.注意如果缺省版本,则会默认拉取名为`latest`版本的镜像.

## 自建镜像仓库

首先强调通常没什么必要自建仓库,官方的已经足够满足一般个人用户的需要.

但如果你是企业用户,自建镜像仓库就是个必选项了,毕竟本地镜像仓库相对更加稳定可靠,而且如果完全在内网环境也比较省流量钱.

### 安装harbor

自建镜像仓库首选[harbor](https://github.com/goharbor/harbor).它除了是一个镜像仓库,顺便还可做镜像安全检查.

harbor的部署完全依赖docker,官方有两种部署方式:

1. 单节点部署
2. 集群化高可用部署

个人更加建议单节点部署而不是集群化高可用部署,因为

1. 作为一个镜像仓库它并不是业务的主体,不该占用过多的资源.
2. 镜像的推拉操作相对比较低频,用不着太多资源

本文也将只介绍单节点部署的

部署harbor的的基本需求是:

+ x86/64平台(亲测arm平台部署不起来)
+ linux系统
+ 2核cpu+
+ 4G内存+
+ 40G硬盘+
+ docker(版本不能太低)
+ docker-compose(版本不能太低)
+ ssl(版本不能太低)
+ 可用的PostgreSQL数据库(可选)

安装的步骤如下:

1. 下载[安装包](https://github.com/goharbor/harbor/releases/tag/v2.1.1)建议下载offline版本的安装包.下载完后解压到要安装的机器上.
2. 配置ssl认证和私钥(可选)
3. 在自己的PostgreSQL数据库中创建需要的库和用户(可选)
4. 配置harbor,根据模板文件`harbor.yml.temp`编辑配置文件`harbor.yml`
5. 执行安装脚本`install.sh`

### 配置harbor的安装

harbor的安装是组件化的,我们可以先把配置都配好然后根据需要选择是否要特定的功能.harbor的功能包括:

+ 基本的镜像仓库和用户权限管理
+ 镜像漏洞扫面(--with-clair/--with-trivy)
+ 镜像签名校验(--with-notary)
+ Helm Charts仓库(--with-chartmuseum)

我们只需要在配置文件中按需填写配置,然后在安装时我们只需要执行`./install.sh --xxxx`就可以重置安装harbor了.

#### 配置和安装

```yaml
## 无论如何都要配的

# 你的harbor对外的域名,不要使用`localhost`,`0.0.0.0`或者`127.0.0.1`,如果有域名就用域名,没有就用宿主机的ip地址
hostname: reg.mydomain.com

# 默认初始admin用户的初始密码
harbor_admin_password: Harbor12345

## log相关
log:
  # options are debug, info, warning, error, fatal
  level: info
  # configs for logs in local storage
  local:
    # Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated.
    rotate_count: 50
    # Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes.
    # If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G
    # are all valid.
    rotate_size: 200M
    # The directory on your host that store log
    location: /var/log/harbor

## 任务调度服务配置
jobservice:
  # 最大执行者数量
  max_job_workers: 10

## 提醒相关设置
notification:
  # Maximum retry count for webhook job
  webhook_job_max_retry: 10

## 通讯协议和安全相关

# http 协议相关的配置,生产环境不要用http协议,应该全部使用https协议,注释掉就禁用了
http:
  # http协议开放的端口,如果`https`协议有配置,则这个端口会重新定向给https的端口
  port: 80

# https 协议相关的配置,生产环境无论内网外网都应该使用https协议,注释掉就禁用了
https:
  # https协议的端口,默认 443
  port: 443
  # https协议使用的签名和私钥
  certificate: /your/certificate/path
  private_key: /your/private/key/path

# 在harbor各个组件间通信时使用tls加密,可以注释掉禁用,建议注释掉
# internal_tls:
#   enabled: true
#   # tls的证书和私钥位置所在的文件夹
#   dir: /etc/harbor/tls/internal


# 当使用外部代理时使用,指名外部代理使用的域名,不建议设置
# external_url: https://reg.mydomain.com:8433

# 配置全局代理,不建议设置
proxy:
  http_proxy:
  https_proxy:
  no_proxy:
  components:
    - core
    - jobservice
    - clair
    - trivy


## 数据存储
# 数据存放位置,主要是指的镜像存放的位置,默认使用本地硬盘存储,也可以配置如azure, gcs, s3, swift, oss作为数据存储后端,不使用本地硬盘存储可以注释掉
data_volume: /data

# 使用存储服务的配置,建议注释掉
storage_service:
  # 存储服务的证书位置
  ca_bundle:

  # 存储的后端,默认为filesystem, 可选的包括 filesystem, azure, gcs, s3, swift, oss.
  # 具体设置可以看[docker的相关配置](https://docs.docker.com/registry/configuration/)
  filesystem:
    maxthreads: 100
  # set disable to true when you want to disable registry redirect
  redirect:
    disabled: false


# Harbor 的数据库设置,如果不用外部数据harbor会根据这个设置启动一个postgresql作为数据库.
# 建议关闭和其他比如代码仓库,jekins等一起公用一个数据库实例统一管理,减少维护成本
database:
  password: root123
  max_idle_conns: 50
  max_open_conns: 1000

# 使用外部数据库,建议使用
external_database:
  # harbor基础服务的数据库配置
  harbor:
    host: harbor_db_host
    port: harbor_db_port
    db_name: harbor_db_name
    username: harbor_db_username
    password: harbor_db_password
    ssl_mode: disable
    max_idle_conns: 2
    max_open_conns: 0
  # 镜像漏洞检测服务相关的数据库配置
  # 如果使用--with-clair开启镜像漏洞检测且使用外部数据库就需要配置
  clair:
    host: clair_db_host
    port: clair_db_port
    db_name: clair_db_name
    username: clair_db_username
    password: clair_db_password
    ssl_mode: disable
  # 镜像签名的签名服务相关的数据库配置
  # 如果使用--with-notary开启镜像签名且使用外部数据库就需要配置
  notary_signer:
    host: notary_signer_db_host
    port: notary_signer_db_port
    db_name: notary_signer_db_name
    username: notary_signer_db_username
    password: notary_signer_db_password
    ssl_mode: disable
  # 镜像签名服务相关的数据库配置
  # 如果使用--with-notary开启镜像签名且使用外部数据库就需要配置
  notary_server:
    host: notary_server_db_host
    port: notary_server_db_port
    db_name: notary_server_db_name
    username: notary_server_db_username
    password: notary_server_db_password
    ssl_mode: disable


# 如果使用外部redis则需要配置这个,建议和其他运维工具共用redis降低维护成本
external_redis:
  # support redis, redis+sentinel
  # host for redis: <host_redis>:<port_redis>
  # host for redis+sentinel:
  #  <host_sentinel1>:<port_sentinel1>,<host_sentinel2>:<port_sentinel2>,<host_sentinel3>:<port_sentinel3>
  host: redis:6379
  password:
  # sentinel_master_set must be set to support redis+sentinel
  #sentinel_master_set:
  # db_index 0 is for core, it's unchangeable
  registry_db_index: 1
  jobservice_db_index: 2
  chartmuseum_db_index: 3
  clair_db_index: 4
  trivy_db_index: 5
  idle_timeout_seconds: 30

## 具体功能性服务的设置

# 配置 Clair 
clair:
  # 多少小时更新一次clair的漏洞数据库
  updaters_interval: 12

# 配置Trivy
# Trivy DB contains vulnerability information from NVD, Red Hat, and many other upstream vulnerability databases.
# It is downloaded by Trivy from the GitHub release page https://github.com/aquasecurity/trivy-db/releases and cached
# in the local file system. In addition, the database contains the update timestamp so Trivy can detect whether it
# should download a newer version from the Internet or use the cached one. Currently, the database is updated every
# 12 hours and published as a new release to GitHub.
trivy:
  # ignoreUnfixed The flag to display only fixed vulnerabilities
  ignore_unfixed: false
  # skipUpdate The flag to enable or disable Trivy DB downloads from GitHub
  #
  # You might want to enable this flag in test or CI/CD environments to avoid GitHub rate limiting issues.
  # If the flag is enabled you have to download the `trivy-offline.tar.gz` archive manually, extract `trivy.db` and
  # `metadata.json` files and mount them in the `/home/scanner/.cache/trivy/db` path.
  skip_update: false
  #
  # insecure The flag to skip verifying registry certificate
  insecure: false
  # github_token The GitHub access token to download Trivy DB
  #
  # Anonymous downloads from GitHub are subject to the limit of 60 requests per hour. Normally such rate limit is enough
  # for production operations. If, for any reason, it's not enough, you could increase the rate limit to 5000
  # requests per hour by specifying the GitHub access token. For more details on GitHub rate limiting please consult
  # https://developer.github.com/v3/#rate-limiting
  #
  # You can create a GitHub token by following the instructions in
  # https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line
  #
  # github_token: xxx

# 配置 chartmuseum
chart:
  # Change the value of absolute_url to enabled can enable absolute url in chart
  absolute_url: disable
```

个人对安装时的建议是:

+ 将harbor部署在内网而非外网
+ 一般使用只需要使用`./install.sh --with-clair`开启漏洞检查就足以应付.
+ 不介意多个外部依赖的可以使用`./install.sh --with-clair --with-trivy`做个双重保护,个人觉得没必要.
+ 如果要部署到外网,应该开启镜像签名`./install.sh --with-clair --with-notary`
+ 如果要用k8s,应该开启`--with-chartmuseum`如果只是单机docker环境或者swarm环境则不建议开启.

需要注意安装的时候可能会报错找不到路径`common/config`,这时候手动创建就好了.

### 使用harbor

harbor集成了用户管理,镜像分组等基本功能



### 使用Notary确保仓库与Docker客户端间的交互可信任


Docker对安全模块进行了重构，剥离出了名为Notary的独立项目。Notary的目标是保证server和client之间的交互使用可信任的连接，用于解决互联网的内容发布的安全性。该项目并未局限于容器应用，在容器场景下可以对镜像源认证、镜像完整性等安全需求提供更好的支持。

### 利用harbor做镜像安全检查

我们可以在


### 使用p2p技术分布式分发镜像


