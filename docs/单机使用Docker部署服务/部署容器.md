# Docker部署容器

### 指定部署行为

在指定好镜像后,如果镜像本身已经定义了`CMD`或者`ENTERYPOINT`那么容器就已经可以启动了.但很多时候我们需要指定部署的一些行为.
不考虑利用外部资源的情况下主要包括:

+ 资源限制
+ 重启策略
+ 传入参数
+ 启动服务
+ 服务标签
+ log收集

#### 资源限制

docker相比起直接部署的一个优势就在于可以限制使用的资源.在开发的时候可以限制好资源开发,避免出现资源占用过高后不得不拔电源重启的情况.

docker的资源限制相关的配置在`v2`版本的compose语法中在如下字段中:

字段|说明|数据类型
---|---|---
`cpu_count`|使用几个核|int
`cpu_percent`|使用cpu的多少百分比的资源(0,100)|int
`cpus`|总共使用多少cpu资源|float
`cpu_shares`|cpu的共享权重|int
`cpu_quota`|限制CPU的CFS配额,必须不小于1ms,即>= 1000|int
`cpu_period`|限制CPU的CFS的周期范围从100ms~1s|str,单位一般时ms
`cpuset`|允许使用的CPU集合|str,取值为`0-3`或者`0,1`这种形式
`mem_limit`|内存限制,最小4m|str,单位可以是b,k,m,g
`memswap_limit`|内存+交换区大小总限制|str,单位可以是b,k,m,g
`mem_swappiness`|置容器的虚拟内存控制行为,值为`0~100`之间的整数|int
`mem_reservation`|内存的软性限制|str,单位可以是b,k,m,g
`oom_kill_disable`|当oom时不会杀死当前进程|bool
`oom_score_adj`|系统内存不够时,容器被杀死的优先级.负值更教不可能被杀死而正值更有可能被杀死|int

```yml
...
cpu_percent: 50
cpus: 0.5
cpu_shares: 73
cpu_quota: 50000
cpu_period: 20ms
cpuset: 0,1
...
```

如果服务或容器尝试使用的内存超过系统可用的内存,则可能会遇到内存不足异常(俗称oom),docker内核会杀掉容器进程或者Docker守护程序.为防止这种情况发生,应该确保应用程序在具有足够内存的主机上运行.

docker一般推荐一个容器只起一个进程,这样在杀死进程的时候可以避免僵尸进程.

#### 重启策略

docker的另一个优势就是可以自动重启,这对于一些需要开机自启动的程序相当友好.

docker的重启策略相关的配置在在`v2`版本的compose语法中通过`restart`字段规定.其形式如下:

```yml
...
restart: on-failure
...
```

其中取值范围可以有4种:

+ `on-failure`只在启动失败时重启
+ `any`,在任何情况下重启(默认值)
+ `none`,在任何情况下都不重启
+ `unless-stopped`除了正常停止以外都会重启

### 传入参数

在docker下一般推荐使用环境变量来传入参数,我们可以使用字段`environment`来指定要传入参数的键值对.其形式如下:


```yml
environment:
    ENV: development
    SHOW: 'true'
    SESSION_SECRET: 'a secret'
```

或者

```yml
environment:
  - ENV=development
  - SHOW=true
  - SESSION_SECRET='a secret'
```

需要注意`environment`字段相当于在容器中设置环境变量,这个操作是在创建容器时执行的,它无法影响镜像的编译过程.


### 启动服务

如果我们不想用镜像中指定的启动方式,我们可以在字段`command`中定义容器中程序的启动行为.其形式如下:

```yml
command: python3 manage.py runserver 0.0.0.0:8000
```

或者

```yml
command: ["python3","manage.py","runserver","0.0.0.0:8000"]
```

如果要执行多行,则可以这样写:

```yml
command:
    - sh
    - -c 
    - |
        cmd1
        cmd2
        cmd3
```

### 服务标签

服务标签并不会影响服务的运行,它是一个关于该服务的元数据,一些框架会使用服务的标签做一些文章.其形式为:

```yml

labels:
  com.example.description: "Accounting webapp"
  com.example.department: "Finance"
  com.example.label-with-empty-value: ""
```

### log收集.

docker中容器打出的log都会被docker收集,关于log收集一块的配置在关键字`logging`部分定义,其形式如下:

```yml
logging:
  driver: "json-file"
  options:
    max-size: "200k"
    max-file: "10"
```

通常我们都是使用的如上面的配置方式,它规定了该服务的log的形式时jsonfile,同时单log文件大小最大为200k,最多会存在10个log文件.

关于docker下的log收集时另一个话题,我们会在介绍完`swarm`后专门介绍.

## 挂载数据卷

### 挂载nfs

## 映射端口

## 调用gpu

## 访问宿主机其他硬件


## 容器相关操作


| 说明                             | 命令                                   | 额外参数                                                                                                                                                                    |
| -------------------------------- | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 查看定义了的容器                 | docker ps [option]                     | 默认:当前运行的镜像</br>-a:全部镜像</br>-l:最近启动的镜像                                                                                                                   |
| 查看单个容器属性                 | docker inspect {name                   | cid}                                                                                                                                                                        | ---                         |
| 查看容器的log信息                | docker logs [option] {name             | cid}                                                                                                                                                                        | `--tail {n} `:查看末尾的n行 |
| 删除镜像                         | docker rm {cid}                        | ---                                                                                                                                                                         |
| 启动镜像                         | docker start {name                     | cid}                                                                                                                                                                        | ---                         |
| 重启镜像                         | docker restart {name                   | cid}                                                                                                                                                                        | ---                         |
| 附着到正在运行中的容器上实现会话 | docker attach {name                    | cid}                                                                                                                                                                        | ---                         |
| 停止镜像                         | docker stop {name                      | cid}                                                                                                                                                                        | ---                         |
| 由镜像创建容器                   | docker run [options]{imagesname}[:tag] | `--restart={flag}`:设定镜像重启等级</br>`--name {name}`:为镜像取个名</br>`-d`:守护进程启动 </br>`-t -i`:启动shell允许输入</br>`-p`:设定host和端口</br>`-v`:设定宿主机挂载卷 |